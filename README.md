
# k8s-event-parser

This repository provides a Kubernetes-based setup for deploying and managing a PostgreSQL database to support the **k8s-event-parser** application, along with a FastAPI-based Python application.

## Prerequisites

- A running Kubernetes cluster
- `kubectl` CLI installed and configured to interact with the cluster
- Python 3.9+ installed on your local machine
- `pip` (Python package installer)

## Deployment Steps for PostgreSQL

1. Create a namespace
    ```bash
    kubectl create namespace my-secrets
    ```


1. Apply the PostgreSQL secrets configuration:
   ```bash
   kubectl apply -f postgres/postgres-secrets.yaml 
   ```

2. Set up the Persistent Volume (PV):
   ```bash
   kubectl apply -f postgres/postgres-pv.yaml 
   ```

3. Set up the Persistent Volume Claim (PVC):
   ```bash
   kubectl apply -f postgres/postgres-pvc.yaml 
   ```

4. Deploy PostgreSQL using the deployment configuration:
   ```bash
   kubectl apply -f postgres/postgres-deployment.yaml 
   ```

5. Expose the PostgreSQL service:
   ```bash
   kubectl apply -f postgres/postgres-service.yaml 
   ```

5. Forward the postgresql port
    ```bash
    kubectl port-forward svc/postgres-service 5432:5432 -n my-secrets
    ```

## Verification

1. Get the list of Pods in the `my-secrets` namespace:
   ```bash
   kubectl get pods -n my-secrets
   ```

2. Access the PostgreSQL Pod:
   ```bash
   kubectl exec -it <postgres-pod-name> -n my-secrets -- /bin/bash
   ```

3. Connect to the PostgreSQL instance:
   ```bash
   psql -U <postgres-username> -d <database-name>
   ```

4. Run a query to verify connectivity:
   ```sql
   SELECT version();
   ```

---

## Running the FastAPI Application

### Step 1: Install Dependencies

1. Navigate to the project directory where the `requirements.txt` file is located.

2. Install the required Python packages using `pip`:
   ```bash
   pip install -r requirements.txt
   ```

3. Place `.secrets.toml` file in the root of the project directory.
    ```bash
    [postgres]
    POSTGRES_DB = "xxxxxxxx"
    POSTGRES_USER = "xxxxxxxx"
    POSTGRES_PASSWORD = "xxxxxxxxxx"
    POSTGRES_HOST = "xxxxxxxx"
    POSTGRES_PORT = xxxx
    ```
### Step 2: Run the Application

1. Start the FastAPI application:
   ```bash
   python app.py
   ```

2. Access the API documentation in your browser:
   ```
   http://127.0.0.1:8000/docs
   ```

   This interactive documentation is automatically generated by FastAPI.

### Step 3: Run the `parse-pod-events` Endpoint

1. Use the following payload to invoke the endpoint:
   ```json
   {
       "namespace": "saifty-flux"
   }
   ```

2. Call the endpoint (e.g., using `curl`, `Postman`, or any HTTP client). Example with `curl`:
   ```bash
   curl -X POST "http://127.0.0.1:8000/parse-pod-events" -H "Content-Type: application/json" -d '{"namespace": "saifty-flux"}'
   ```

3. Efficiently Storing Data in the Postgresql Database
    ```bash
    {
        "id": 1,
        "pod_name": "pod-1",
        "event_type": "Warning",
        "reason": "FailedScheduling",
        "message": "Pod could not be scheduled due to insufficient CPU resources.",
        "timestamp": "2024-12-01T12:00:00Z"
    }
    ```
---

Feel free to customize this file further based on your project specifics!